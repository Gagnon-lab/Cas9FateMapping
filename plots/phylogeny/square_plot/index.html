<!DOCTYPE html>
<html lang='en' xml:lang='en' xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <meta content='text/html;charset=UTF-8' http-equiv='content-type'>
    <title>Right-angle phylograms and dendrograms with d3</title>
    <script src="http://d3js.org/d3.v3.min.js" type="text/javascript"></script>
    <script src="tree.js" type="text/javascript"></script>
    <script src="newick.js" type="text/javascript"></script>
    <script src="d3.phylogram.js" type="text/javascript"></script>
    <script>
      function load() {
        var newick = Newick.parse(newickStringRep) // defined in the input file
        var newickNodes = []
        function buildNewickNodes(node, callback) {
          newickNodes.push(node)
          if (node.branchset) {
            for (var i=0; i < node.branchset.length; i++) {
              buildNewickNodes(node.branchset[i])
            }
          }
        }
        buildNewickNodes(newick)
		// taxa    name    sample  depth   numberOfReads   events  fullName
        // ------------------------------------------------------------------------------------------------------
        // load up the annotations file here and update the tree with nicer features
        // ------------------------------------------------------------------------------------------------------
        d3.tsv("merged_just_7.annotations", function(error2, data2) { // embryo_annotations_with_reads.txt
                var color = d3.scale.category10()
                        // .domain(["1","2","3","4","5","6","7"]);

                // create mappings of the names to known clade, event strings, and read counts
                // taxa    name    sample  depth   numberOfReads   events  fullName --- taxa    sample  count   eventString
                var nameToClade = data2.reduce(function(map, obj) {map[obj.taxa] = obj.sample; return map;}, {});

                var nameToEvent = data2.reduce(function(map, obj) {map[obj.taxa] = obj.eventString; return map;}, {});

                // also store off the counts as an array, we use this to scale the separation between nodes
                var counts = new Array();
                var nameToCount = data2.reduce(function(map, obj) {
	          map[obj.taxa] = +obj.count; // +obj.numberOfReads;
                  if (obj.taxa != "NONE") {counts.push(+obj.count);} // +obj.numberOfReads);}
                  return map;
                }, {});

                // develop a scale for read counts
                var max = d3.max(counts)
                var countsScale = d3.scale.linear()
                    .domain([0, max])
                    .range([5,20]);

                var nodeTransform = function(d) {
                      return countsScale(nameToCount[+d])
			      };

			      var nodeToEvt = function(d) {
                      return nameToEvent[d];
                };
                var colorNameTransform = function(d) {
                      return color(nameToClade[d])
                };

			      d3.phylogram.build('#phylogram', newick, {
			      width: 1500,
			      height: 6000
			      },
			      nodeTransform,
			      colorNameTransform,
			      nodeToEvt
			      );
        });

      }


    </script>
    <style type="text/css" media="screen">
      body { font-family: "Helvetica Neue", Helvetica, sans-serif; }
      td { vertical-align: top; }
    </style>
  </head>
  <body onload="load()">
    <table>
      <tr>
        <td>
          <h2>Phylogram</h2>
          <div id='phylogram'></div>
        </td>
      </tr>
    </table>
  </body>
</html>
