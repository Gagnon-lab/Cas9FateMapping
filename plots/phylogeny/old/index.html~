<!DOCTYPE html>
<html lang='en' xml:lang='en' xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <meta content='text/html;charset=UTF-8' http-equiv='content-type'>
    <title>Right-angle phylograms and dendrograms with d3</title>
    <script src="http://d3js.org/d3.v3.min.js" type="text/javascript"></script>
    <script src="newick.js" type="text/javascript"></script>
    <script src="d3.phylogram.js" type="text/javascript"></script>
    <script>
      function load() {
        var newick = Newick.parse("(((((146:0.4149300189,167:0.2855415592):0.007783893294,(26:0.1955764953,41:0.4064490111):0.01870536197):0.007281397864,((22:0.1254559404,130:0.3912191162):0.03276204805,221:0.4187272072):0.0107239745):0.0008201338648,((116:0.2018957148,134:0.4004518689):0.02771003283,((((((179:0.2917779928,189:0.2246859101):0.03332984185,193:0.4166701581):0.004901187512,(142:0.3895181825,183:0.400943079):0.03259881249):0.00142004202,((((11:0.2895556244,188:0.222793585):0.03331857813,178:0.4166814219):0.003550566274,(191:0.3011235738,197:0.319433442):0.03394943373):0.001148059356,((185:0.3605860902,198:0.3406960779):0.01757742147,((186:0.3208629338,190:0.3800659881):0.01248425364,195:0.3269772776):0.01992257853):0.003539440644):0.00170495798):0.0009235847977,(((180:0.3478650075,194:0.254579336):0.0127879402,181:0.3158325172):0.03198317431,102:0.4180168257):0.005717040202):0.001721902423,((12:0.2957377936,182:0.2682021577):0.03330323674,10:0.4166967633):0.008824972577):0.2895506179):0.003897883077):0.0002868656847,((((((153:0.1119532648,209:0.3907023755):0.03290698732,126:0.4192550577):0.009645248438,(106:0.2341052986,271:0.4009817152):0.02785475156):0.0008076138931,(((((((((((((((((58:0.1208000525,76:0.3820815735):0.03146753949,100:0.3694163669):0.007997368797,(4:0.3292510738,86:0.2756051921):0.0295026312):0.00100858303,(((3:0.2907080371,66:0.1280703867):0.03261169739,63:0.3684592957):0.008367140013,(64:0.3414038682,98:0.3598812408):0.01663285999):0.002000301741):0.0009436047388,(((60:0.3070655959,72:0.2011418162):0.03142967224,80:0.3689701009):0.007715950795,(57:0.3601691768,59:0.3411716964):0.01728404921):0.002239452875):0.0007446340759,((61:0.3895638543,77:0.01439638395):0.02763926446,87:0.3744076155):0.006286615924):0.0008229202663,((69:0.3036578179,94:0.3239337785):0.02380716562,91:0.3261928344):0.008802183278):0.0007772626921,((65:0.3262087723,90:0.2854984727):0.02671068963,68:0.3753361903):0.006779377311):0.001383214803,((2:0.3915120164,97:0.2453364775):0.02679676842,67:0.3762670894):0.008119715196):0.0002470397121,((75:0.2923170757,81:0.315855605):0.02684757242,84:0.3762162854):0.008361995833):0.0007763896709,((((74:0.2864393362,95:0.316044179):0.01048543233,78:0.3895145677):0.005280164137,62:0.3947198359):0.01677792337,(88:0.3004664734,92:0.3157349653):0.02829450444):0.007644922635):0.001637695503,71:0.3953134698):0.005116696883,(73:0.2329169147,96:0.3699361916):0.01863754383):0.003237267176,(89:0.3702682173,99:0.2373132242):0.02176305387):0.002935016765,(82:0.4180571583,83:0.3744513664):0.02206498323):0.26021386,265:0.4184210523):0.009856826852,(148:0.234247955,262:0.4008413194):0.02771946709):0.0009056664576):0.001506723208,((131:0.4143893208,132:0.294340007):0.01096868483,((((((((((((236:0.2525432277,238:0.06930974676):0.03278996737,261:0.3750566661):0.008250308118,(257:0.3142971704,259:0.2912897382):0.02924969188):0.00207480198,276:0.332791808):0.003276818145,((246:0.2798358905,275:0.2244566466):0.01842539918,(244:0.1783431129,248:0.3245301937):0.03157460082):0.004535681855):0.001920849272,(((255:0.2872206911,267:0.2267886525):0.01912902823,(239:0.2188922709,254:0.386193914):0.03087097177):0.003138138738,((((253:0.281802549,269:0.1215414277):0.03270918416,279:0.3704805256):0.007435970213,(268:0.2866993837,281:0.2214794751):0.03006402979):0.002378290317,249:0.3292020137):0.003111861262):0.002571338228):0.001274441618,(((((250:0.4,280:0.4):0.004598537546,(272:0.1606943066,274:0.2860528991):0.03422389027):0.00658125218,(247:0.1372755074,282:0.384169365):0.03091874782):0.00234333621,263:0.3652438757):0.004266737659,(252:0.2506305349,264:0.2776464586):0.02385826234):0.001899386507):0.001629668952,(((19:0.3774328506,245:0.1589546891):0.03643700805,242:0.3213792226):0.008412681703,(243:0.1986283595,270:0.3065502292):0.0165873183):0.003044299579):0.001050751971,((258:0.2665091575,266:0.3681539402):0.01655463429,(256:0.3681875261,283:0.266467654):0.01655463429):0.002433117751):0.00419749187,278:0.4048538932):0.01107089629,277:0.4508747402):0.2375195158,139:0.4126647847):0.01412897142):0.004512734874):0.0004501147722,((((149:0.4161422148,164:0.2868562144):0.0119799422,(40:0.4152815914,168:0.2925346392):0.0130200578):0.0006266413768,(119:0.278956064,128:0.258559862):0.03734769481):0.001969228206,((166:0.3916634756,237:0.1099972263):0.03274286254,199:0.4187463927):0.01053077179):0.001178229994):0.0002579150718,((((((15:0.3921702726,79:0.1104853677):0.03293292789,8:0.4192291171):0.008790012427,(121:0.2433823101,158:0.3990362702):0.02870998757):0.001987042621,(((125:-0.1147603915,155:0.3196457556):0.03407752385,192:0.3666086357):0.003371774112,((187:0.3919014391,260:0.1487136842):0.03290618921,159:0.4192558558):0.008587714639):0.002565329567):0.0007792827922,((((143:0.2983103557,174:0.1281122512):0.03280499087,17:0.4181783186):0.00903129249,(85:0.3998139739,114:0.2008839483):0.02846870751):0.002028125345,((117:0.4151977668,175:0.2976325372):0.009054178779,(103:0.4068437986,151:0.2136261512):0.01655545604):0.007346874655):0.0009859089264):0.0001056933322,(((((111:0.296444458,184:0.4161629539):0.01265396507,(18:0.390673524,251:0.1457140158):0.03778679271):0.001448767568,(((23:0.9325027743,101:0.2983740867):0.03270344851,240:0.4182798609):0.006682569599,((((((((((16:0.2937125976,56:0.2208004695):0.0274563205,203:0.3803483705):0.005801756058,54:0.3217843405):0.004899716722,235:0.3919289416):0.001481616812,((((127:0.3852323651,205:0.2485490977):0.02618433507,39:0.3748906409):0.005608221469,201:0.3355083885):0.002191228168,(((((33:0.3851360974,215:0.2722411133):0.01807359523,(37:0.2833013716,200:0.1772757761):0.02823779942):0.005344410775,233:0.3730907363):0.004144377773,44:0.2400326746):0.003659200167,((34:0.2159491609,206:0.3847385772):0.0263539316,224:0.3747726673):0.005715799833):0.002373369347):0.003169678181):0.0008950514474,((((((((1:0.2840005598,25:0.1217634759):0.0311234822,220:0.3719099076):0.005190079503,231:0.2201994175):0.004589850058,((226:0.3846654275,234:0.2297525361):0.02624246988,50:0.3744232579):0.004785149942):0.003463391993,(((43:0.2213476689,52:0.3847014925):0.0262125,202:0.3739639272):0.004708202074,(((51:0.1367195846,217:0.2871469388):0.02136271831,230:0.2820586457):0.009998727605,24:0.3165391569):0.004666797926):0.003567858007):0.001185458456,(((14:0.3845940959,207:0.2168025702):0.02632571788,31:0.374800881):0.005445906894,46:0.3329100054):0.003892666544):0.0006923206975,(((0:0.3846296296,216:0.2503879246):0.02629105953,228:0.3738506454):0.005418686153,27:0.3329372261):0.004562451234):0.0009134326567,((((32:0.2179623874,47:0.1089801731):0.03133511673,210:0.3688342298):0.007757391079,29:0.3317962473):0.005859244959,211:0.3894873886):0.002416212627):0.001056576727):0.0002870241586,(((((48:0.3151138909,212:0.2356835529):0.0274333004,129:0.373555687):0.005766213389,219:0.3197850397):0.004834559651,36:0.3919940987):0.002187556821,(((38:0.3065768853,213:0.3256809163):0.01712347225,42:0.3828765278):0.01425347749,229:0.3276899712):0.006406193179):0.0003696967802):0.0008920427974,((((35:0.3,214:0.3):0.1026785807,160:0.3877826808):0.02486387656,227:0.3771833866):0.0051413463,225:0.3686958656):0.006348330314):0.0007441593024,((((118:0.2144918639,232:0.2901126099):0.02743688404,222:0.3747291809):0.005815094305,55:0.3238962103):0.006713962361,((30:0.4,49:0.4):-3.60822483e-16,204:0.4):0.01960846545):0.002264936945):0.003299492773,((((53:0.2530314259,223:0.3471543471):0.001427907953,28:0.348572092):0.0007165129515,45:0.349283487):0.04670425626,208:0.383144392):0.008924488823):0.5745095125):0.004258095894):0.0006887265687,((((70:0.414864121,135:0.2864233272):0.01252200194,(144:0.3209402074,176:0.2155809631):0.03747799806):0.0004999582692,(((((((((((147:0.4078183594,172:0.2931944617):0.01966039914,(113:0.3317647561,163:0.2689911537):0.03033960086):0.001025614057,((154:0.30073791,171:0.2024433568):0.0281735271,141:0.3748903307):0.005224385943):0.002220714125,((((5:0.3331628102,145:0.307037392):0.007371124077,169:0.3926288759):0.003742343627,133:0.3962576564):0.01767068999,(115:0.2213384028,157:0.2826513444):0.03019613086):0.004029285875):0.0007335441107,(((((7:0.2988798869,137:-0.0807000332):0.02907620464,140:0.3729706753):0.005293397539,(104:0.3429126253,173:0.3588898373):0.01970660246):0.001304761961,(6:0.3986738091,156:0.3917874524):0.02994523804):0.001678105399,((105:0.3968583618,162:0.2186112017):0.02218640641,109:0.3778135936):0.01079872377):0.0009141308265):0.0006275227194,((120:0.3007422487,161:0.2044767176):0.02821086001,110:0.3796357735):0.008648132365):0.001502991311,107:0.3157959019):0.008684926445,(((170:0.2284613816,177:0.3046964644):0.02814207749,165:0.3722544768):0.009528717074,123:0.3156882547):0.00894047764):0.008856989324,124:0.3811675205):0.009518729796,108:0.4182826553):0.133536429,196:0.4171563891):0.01041312767):0.002081184037,((9:0.3914382935,138:0.1207348298):0.03272461291,13:0.4187646424):0.01063243901):0.0007894114965):0.0004192405799,(((93:0.4151709046,152:0.2882410335):0.01286523906,(((21:0.3572972266,122:0.4492655141):0.0003725653227,20:0.4496274347):0.008125511925,241:0.1455804106):0.03713476094):0.0004723149115,(((218:0.11868417,273:0.3819647256):0.03284713866,150:0.4218527669):0.008122734801,(112:0.4147838566,136:0.2868912422):0.0168772652):0.001877637884):0.002341335835):0.000224906627):7.105158248e-06);")
        var newickNodes = []
        function buildNewickNodes(node, callback) {
          newickNodes.push(node)
          if (node.branchset) {
            for (var i=0; i < node.branchset.length; i++) {
              buildNewickNodes(node.branchset[i])
            }
          }
        }
        buildNewickNodes(newick)

        // ------------------------------------------------------------------------------------------------------
        // load up the annotations file here and update the tree with nicer features
        // ------------------------------------------------------------------------------------------------------
        d3.tsv("cell_annotation_full.txt", function(error2, data2) {
                var color = d3.scale
                        .category10()
                        .domain(["1","2","3","4","5","6","7"]);

                // create mappings of the names to known clade, event strings, and read counts`
                var nameToClade = data2.reduce(function(map, obj) {map[obj.name] = obj.clade; return map;}, {});

                var nameToEvent = data2.reduce(function(map, obj) {map[obj.name] = obj.events; return map;}, {});

                // also store off the counts as an array, we use this to scale the separation between nodes
                var counts = new Array();
                var nameToCount = data2.reduce(function(map, obj) {map[obj.name] = +obj.numberOfReads;
                  if (obj.name != "NONE") {counts.push(+obj.numberOfReads);}
                  return map;
                }, {});

                // develop a scale for read counts
                var max = d3.max(counts)
                var countsScale = d3.scale.linear()
                    .domain([0, max])
                    .range([1,500]);

                var nodeTransform = function(d) {
                      return countsScale(nameToCount[+d])
                };
                var colorNameTransform = function(d) {
                      return color(nameToClade[d])
                };

                d3.phylogram.build('#phylogram', newick, {
                  width: 800,
                  height: 2000
                },
                nodeTransform,
                colorNameTransform);
        });

      }


    </script>
    <style type="text/css" media="screen">
      body { font-family: "Helvetica Neue", Helvetica, sans-serif; }
      td { vertical-align: top; }
    </style>
  </head>
  <body onload="load()">
    <table>
      <tr>
        <td>
          <h2>Phylogram</h2>
          <div id='phylogram'></div>
        </td>
      </tr>
    </table>
  </body>
</html>
